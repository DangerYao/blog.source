---
title: JVM概述
date: 2018-09-04 18:22:38
categories:
 - technology
 - java
 - jvm
tags:
 - technology
 - java
 - jvm
---


* JVM是什么
* JVM的作用
* Java是如何运行的
* JVM的效率怎样


##### Java的运行方式

 - 在开发工具中运行
 - 双击执行Jar文件
 - 在命令行中运行
 - 在网页中运行

*不过，这一切都离不开JRE-Java运行环境*   

JRE仅仅包括Java程序的必需组件，包括Java虚拟机(JVM)和Java核心类库等  
JDK(Java开发工具包)包含了JRE，并且还附带了一系列开发和诊断工具

##### JVM是什么？

JVM(Java Virtual Machine)也就是常说的Java虚拟机，类似于我们常用的虚拟机，它是虚构出来的计算机，可以模拟计算机的相关功能，其自身也包含了指令系统、栈结构、内存模型、线程模型、GC模型等等，其出现的主要目的就是屏蔽计算机各个系统底层的差异，可是让能够运行在JVM上的相关语言能够一次编译、到处运行。  
JVM可以由硬件实现，也可以由软件实现。

##### 为什么Java要在JVM中运行？
    
Java是高级开发语言，不可能直接在物理机上直接运行，要么需要解释，要么需要编译，而编译可以直接编译成为机器码，类似于C/C++，编译后的程序就可以直接在物理机上直接执行，但是物理机是有差异的，不同的物理机或者系统对机器指令的执行和认知情况可能不太一样，这样如果要把开发的程序在其他的机器上运行还需要重新编译，这是一个很麻烦的事情。于是Java才用的是另外一种方案，编译成中间代码，中间代码可以有一个软件或者其他来执行，而这个软件则可以屏蔽物理机的差异，如果需要在其他物理机上部署程序，可以直接把中间代码迁移过去即可，不用再次编译，这个中间代码就是Java字节码（.class），而这个软件或者物理实现的集成功能就是我们所说的JVM，这也是为什么Java需要在JVM中运行，主要就是要实现一次编译、到处运行的口号。  
而且Java在JVM中运行还有一个好处，就是徐丽娟带来了一个托管环境，这个托管环境能够代替我们处理一些代码冗长而且容易出错的部分，比如广为人知的当属内存管理和垃圾回收，除此之外还有数组越界、动态类型、安全权限等动态监测。

##### Java 是如何在JVM中运行的？

*下面主要以标准JDK中HotSpot虚拟机为例，如没有特殊说明，所说的虚拟机都是指HotSpot*

JVM运行的其实是字节码, 所以与其说是解释Java是怎样在JVM中运行的，还不如说是解释虚拟机是如何运行字节码的。  
首先，由Java语言编写的程序会有Java编译器编译成字节码(class文件)，然后加载到Java虚拟机中。加载后的Java类会被存放于方法区中，然后在实际运行时，虚拟机就会执行方法区的代码。  
Java虚拟机主要分为堆和栈来存储运行时数据，栈细分为面向Java方法的方法栈、面向本地方法（native方法，由C++编写）的本地方法栈，以及存放各个线程执行位置的PC寄存器。  
![Java内存](https://m.qpic.cn/psb?/V12IxaQC4QCAPb/VmBMCqUDNA8QspZkT0MgaEVxav05AthZRg9wTvsrVyI!/b/dDQBAAAAAAAA&bo=*wLSAf8C0gEDCSw!&rf=viewer_4)  
运行时，每调用一个Java方法，虚拟机就会在当前线程的Java方法栈中生成一个栈帧，其大小是提前就计算好的，用于存放局部变量以及字节码的操作数，虚拟机不要求栈帧在内存中连续分布。当退出执行的方法时，不管发没发生异常，虚拟机都会弹出当前线程的当前栈帧，并将之舍弃。  
像上面所说，字节码不能在物理机上直接执行，还是需要把字节码转换为机器码才能够被物理机识别，在HotSpot里面，这种转换有两种形式，一种是解释执行，将字节码逐条翻译成为机器码并执行，另一种就是即时编译，也就是JIT(Just-In-Time complilation)，即将一个方法中包含的所有字节码编译成为机器码后再执行。  
![JVM解释编译代码](https://m.qpic.cn/psb?/V12IxaQC4QCAPb/jrja8Kq74S9Kev3SxK8lW6soSjt5MeHBf7aEZQMKhaY!/b/dFoAAAAAAAAA&bo=kAIrApACKwIDCSw!&rf=viewer_4)  
这两种方式各有优劣，前者不需要等待编译，而后者在于实际的运行速度更快。HotSpot采用的就是混合模式，它会先解释执行字节码，然后将其中反复执行的热点代码(HotSpot Code)以方法为单位进行即时编译，也也是HotSpot JVM名字的由来。

##### JVM运行效率如何？

即时编译器建立在二八定律的假设上，即20%的代码占据了80%的计算资源。对于大部分不常用的代码我们无需耗费时间编译成机器码，而是采用解释执行，另一方面。对于小部分热点代码，可以将其编译成机器码，以达到理想的运行速度。  
其实，即时编译后的代码是有可能超过C++程序的，以为其有一个优势，那就是即时编译拥有运行时的信息，与C++的静态编译相比，可以根据这个信息作出相应的优化，而JVM也一直在为这方面努力。  
为了满足不同的用户场景，HotSpot内置了多个即时编译器：C1、C2和Graal, 其中Graal是Java 10正式引入的实验性的即时编译器。之所以引入多个，是为了在编译时间和生成代码的执行效率上进行取舍。C1为Client编译器，主要是面对对启动性能有要求的GUI程序，所以优化手段比较简单，编译时间较短。C2为Server编译器，面向的是对峰值性能有要求的服务器端程序，所以编译时间长，生成代码的执行效率高，优化手段比较复杂。  
从Java 7 开始，HotSpot默认采用的分层编译方式：热点方法首先别C1编译，而后热点方法中的热点会进一步被C2编译。即时编译器的编译过程是在额外的编译线程中进行的，HotSpot会根据CPU的数量设置编译线程的数目，并且按照1:2配置给C1和C2。 

##### 总结

本文主要讲解了：
 - JVM是什么
 - Java为什么，以及如何在JVM中运行
 - JVM运行时内存主要分为：方法区、堆、PC寄存器、方法栈、本地方法栈五个部分
 - class文件必须要先加载到方法区中才能被JVM执行
 - 为了提高运行效率，HotSpot采用解释和即时编译混合的策略

